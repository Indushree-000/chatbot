<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Health Chatbot with Voice Assistant</title>
    <style>
        body {
            font-family: Arial;
            background-color: #f2f5f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .chatbox {
            width: 450px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 350px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .user {
            text-align: right;
            color: #333;
        }

        .bot {
            text-align: left;
            color: #0078d4;
        }

        .input-box {
            display: flex;
            border-top: 1px solid #ddd;
            align-items: center;
            background: #fff;
        }

        select, input, button {
            font-size: 14px;
            border: none;
            padding: 10px;
            outline: none;
        }

        select {
            border-right: 1px solid #ddd;
            background: #f7f7f7;
            border-radius: 10px 0 0 0;
        }

        #user-input {
            flex: 1;
            border: none;
            padding: 10px;
        }

        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 0 0 10px 0;
        }

        button:hover {
            background: #005fa3;
        }

        .mic-btn {
            background: #28a745;
            border-radius: 50%;
            padding: 10px;
            margin-right: 5px;
            cursor: pointer;
            font-size: 16px;
            color: white;
            border: none;
        }

        .mic-btn:hover {
            background: #1e7e34;
        }

        .voice-toggle {
            background: #ff9800;
            border-radius: 50%;
            padding: 10px;
            margin-right: 5px;
            cursor: pointer;
            font-size: 16px;
            color: white;
            border: none;
        }

        .voice-toggle.muted {
            background: #ccc;
        }

        .progress-container {
            height: 6px;
            background: #eee;
            width: 100%;
        }

        .progress-bar {
            height: 6px;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
<div class="chatbox">
    <div class="messages" id="chat-messages"></div>

    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="input-box">
        <select id="language-select">
            <option value="en">English</option>
            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
            <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
        </select>

        <input type="text" id="user-input" placeholder="Type or speak your message...">

        <!-- üé§ Voice Input Button -->
        <button class="mic-btn" onclick="startListening()" title="Speak">üé§</button>

        <!-- üîä Voice On/Off Toggle -->
        <button class="voice-toggle" id="voice-toggle" onclick="toggleVoice()" title="Mute/Unmute">üîä</button>

        <!-- üì§ Send Message Button -->
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    const userId = Date.now();
    let currentLang = 'en';
    let voiceEnabled = true; // Default: Voice ON

    const placeholders = {
        en: "Type or speak your message...",
        hi: "‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ü‡§æ‡§á‡§™ ‡§Ø‡§æ ‡§¨‡•ã‡§≤‡•á‡§Ç...",
        kn: "‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∏‡≤Ç‡≤¶‡≥á‡≤∂‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤á‡≤≤‡≥ç‡≤≤‡≤ø ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤Æ‡≤æ‡≤§‡≤®‡≤æ‡≤°‡≤ø..."
    };

    const greetings = {
        en: "üëã Hello! I am your Health Assistant. Please describe your symptoms (e.g., lump, pain, acne).",
        hi: "üëã ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•Ç‡§Å‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§¨‡§§‡§æ‡§è‡§Ç‡•§",
        kn: "üëã ‡≤®‡≤Æ‡≤∏‡≥ç‡≤ï‡≤æ‡≤∞! ‡≤®‡≤æ‡≤®‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≤π‡≤æ‡≤Ø‡≤ï. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤≤‡≤ï‡≥ç‡≤∑‡≤£‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤µ‡≤ø‡≤µ‡≤∞‡≤ø‡≤∏‡≤ø."
    };

    function setLanguage(lang) {
        currentLang = lang;
        document.getElementById("user-input").placeholder = placeholders[lang];
        document.getElementById("chat-messages").innerHTML = "";
        addMessage("bot", greetings[lang]);
        updateProgress(0);
    }

    document.getElementById("language-select").addEventListener("change", function() {
        setLanguage(this.value);
    });

    function addMessage(sender, text) {
        const chat = document.getElementById("chat-messages");
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", sender);
        msgDiv.innerHTML = text.replace(/\n/g, "<br>");
        chat.appendChild(msgDiv);
        chat.scrollTop = chat.scrollHeight;

        if (sender === "bot" && voiceEnabled) speakText(text);
    }

    function updateProgress(value) {
        document.getElementById("progress-bar").style.width = value + "%";
    }

    async function sendMessage() {
        const input = document.getElementById("user-input");
        const msg = input.value.trim();
        if (!msg) return;

        addMessage("user", msg);
        input.value = "";

        const res = await fetch("/get", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ msg: msg, user_id: userId, lang: currentLang })
        });

        const data = await res.json();
        addMessage("bot", data.response);
        updateProgress(data.progress || 0);
    }

    // üéôÔ∏è Voice Input (Speech Recognition)
    function startListening() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Speech recognition not supported in this browser.");
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = currentLang === 'hi' ? 'hi-IN' : currentLang === 'kn' ? 'kn-IN' : 'en-US';
        recognition.start();

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById("user-input").value = transcript;
            sendMessage();
        };

        recognition.onstart = () => addMessage("bot", "üéß Listening...");
        recognition.onerror = () => addMessage("bot", "‚ùå Sorry, I couldn‚Äôt hear you. Please try again.");
    }

    // üîä Text-to-Speech (Bot Voice Output)
    function speakText(text) {
        const synth = window.speechSynthesis;
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = currentLang === 'hi' ? 'hi-IN' : currentLang === 'kn' ? 'kn-IN' : 'en-US';
        synth.speak(utter);
    }

    // üì¥ Toggle Bot Voice (Mute/Unmute)
    function toggleVoice() {
        voiceEnabled = !voiceEnabled;
        const btn = document.getElementById("voice-toggle");
        btn.textContent = voiceEnabled ? "üîä" : "üîá";
        btn.classList.toggle("muted", !voiceEnabled);
    }

    // Initialize chat
    setLanguage(currentLang);
</script>
</body>
</html>
